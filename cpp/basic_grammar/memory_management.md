# Memory Management

## 存储类别

存储期、作用域（scope）、链接（linkage）

### 作用域 (scope)

-   **块作用域**

    定义在块中的变量，可见范围是从定义出到包含该定义的块的末尾

    另外，函数的形式参数虽然在函数的左花括号之前，但也有块作用域，属于函数体这个块

-   **函数作用域**

    仅用于 goto 语句的标签（《 C Prime Plus 》（第六版） P375 并没有懂）

-   **函数原型作用域**

    用于函数原型中的形参名。如：

    ```c
    int func(int a, double b);
    ```

    函数原型作用域的范围是从形参定义处到原型声明结束。

-   **文件作用域**

    定义在函数的外面的变量，具有文件作用域，该变量也称为全局变量



### 链接 (linkage)

-   **外部链接**

    具有文件作用域的变量可以是外部链接或内部链接，外部链接变量可以再多文件程序中使用

-   **内部链接**

    内部链接只能在一个翻译单元中使用
    
-   **无链接**

    具有块作用域、函数作用域或函数原型作用域的变量都是无链接变量



### 存储期 (storage duration)

-   **静态存储期**

    程序执行期间一直存在

    文件作用域变量具有静态存储期，注意对于文件作用域的变量，关键字 static 表明其链接属性，而非存储期

    无论内部链接还是外部链接，所有文件作用域变量都具有静态存储期

-   **线程存储期**

    具有线程存储期的对象，从被声明到线程结束一直存在

-   **自动存储期**

    块作用域的变量通常都具有自动存储期

    变长数组稍有不同，他们的存储期从声明处到块的末尾

    块作用域也能具有静态存储期，加上 static 即可

-   **动态分配存储期**



| **存储类别** | **存储期** | **作用域** | 链接 | 声明方式                |
| ------------ | ---------- | ---------- | ---- | ----------------------- |
| 自动         | 自动       | 块         | 无   | 块内                    |
| 寄存器       | 自动       | 块         | 无   | 块内，使用 register     |
| 静态外部链接 | 静态       | 文件       | 外部 | 所有函数外              |
| 静态内部链接 | 静态       | 文件       | 内部 | 所有函数外，使用 static |
| 静态无链接   | 静态       | 块         | 无   | 块内，使用 static       |



### 自动变量

注意 auto 关键字 c 与 cpp 的用法不同

属于自动存储类别的变量具有自动存储期、块作用域且无链接。

默认情况下，声明在块或函数头中的任何变量都属于自动存储类别，为了使意图更明显，可显式使用 auto

**变量同名，内层块会隐藏外层快的定义**



### 寄存器变量

存储在寄存器中，而不是内存，故而无法获得寄存器变量的地址

使用 register，编译器会根据情况衡量是否满足程序员的请求



### 块作用域的静态变量

具有块作用域、无链接，但是有静态存储期

只会被初始化一次



## 分配内存

>   此处额外补充一些知识点:
>
>   使用 malloc() 创建二维数组
>
>   ```c
>   int (*p)[m] = (int (*p)[m])malloc(n*m*sizeof(int));
>   ```



内存从低地址到高地址依次为:

代码区、数据区、堆区、栈区

-   **代码区**

    存放程序员写的代码

-   **数据区**

    又分为：

    -   文字常量区
    -   已初始化变量区(Data Segment)
    -   未初始化变量区(BSS)

    存放全局变量，静态变量（static 修饰的变量，包括静态局部变量，静态全局变量），字符串常量。

    已初始化的在低地址，未初始化的在高地址（似乎知道了也没什么用）

    关于字符串常量有以下需要注意

    ```c
    char s1[] = "abc"; // abc 存储在栈中，可以更改
    char *s2 = "abc"; // abc 存储在常量区，不可以更改
    ```

    

-   堆区

    用 malloc/new 请求分配，用 free/delete　销毁内存

    从低地址向高地址分配

-   栈区

    由编译器自动分配释放，存放函数的参数值、局部变量的值

    从高地址向低地址扩展